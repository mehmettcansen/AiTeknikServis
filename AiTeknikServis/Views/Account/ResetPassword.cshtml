@model AiTeknikServis.Entities.Dtos.Auth.ResetPasswordDto
@{
    ViewData["Title"] = "Şifre Sıfırla";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-lock-open me-2"></i>
                        Yeni Şifre Belirle
                    </h4>
                </div>
                <div class="card-body">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="text-center mb-4">
                        <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
                        <h5>Yeni Şifre Oluştur</h5>
                        <p class="text-muted">
                            <strong>@Model.Email</strong> için yeni şifrenizi belirleyin.
                        </p>
                    </div>

                    <form asp-action="ResetPassword" method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        
                        <input type="hidden" asp-for="Email" />

                        <div class="mb-3">
                            <label asp-for="Password" class="form-label">Yeni Şifre</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input asp-for="Password" 
                                       class="form-control" 
                                       type="password"
                                       placeholder="Yeni şifrenizi girin"
                                       autocomplete="new-password" />
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="Password" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                En az 6 karakter, büyük harf, küçük harf ve rakam içermelidir
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ConfirmPassword" class="form-label">Yeni Şifre Tekrar</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input asp-for="ConfirmPassword" 
                                       class="form-control" 
                                       type="password"
                                       placeholder="Şifrenizi tekrar girin"
                                       autocomplete="new-password" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>

                        <!-- Şifre güçlülük göstergesi -->
                        <div class="mb-3">
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="passwordStrengthText">Şifre güçlülüğü</small>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>
                                Şifreyi Kaydet
                            </button>
                        </div>
                    </form>

                    <div class="mt-4">
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Güvenlik Uyarısı:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Güçlü bir şifre seçin</li>
                                <li>Şifrenizi kimseyle paylaşmayın</li>
                                <li>Düzenli olarak şifrenizi değiştirin</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-3">
                <a href="@Url.Action("Login", "Account")" class="text-muted">
                    <i class="fas fa-arrow-left me-1"></i>
                    Giriş sayfasına dön
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Şifre görünürlük toggle
            $('#togglePassword').click(function() {
                var passwordField = $('#Password');
                var icon = $(this).find('i');
                
                if (passwordField.attr('type') === 'password') {
                    passwordField.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    passwordField.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });

            $('#toggleConfirmPassword').click(function() {
                var passwordField = $('#ConfirmPassword');
                var icon = $(this).find('i');
                
                if (passwordField.attr('type') === 'password') {
                    passwordField.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    passwordField.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });

            // Şifre güçlülük kontrolü
            $('#Password').on('input', function() {
                var password = $(this).val();
                var strength = calculatePasswordStrength(password);
                var progressBar = $('#passwordStrength');
                var strengthText = $('#passwordStrengthText');

                progressBar.css('width', strength.percentage + '%');
                progressBar.removeClass('bg-danger bg-warning bg-success');
                
                if (strength.score < 2) {
                    progressBar.addClass('bg-danger');
                    strengthText.text('Zayıf şifre').removeClass('text-success text-warning').addClass('text-danger');
                } else if (strength.score < 4) {
                    progressBar.addClass('bg-warning');
                    strengthText.text('Orta güçlükte şifre').removeClass('text-success text-danger').addClass('text-warning');
                } else {
                    progressBar.addClass('bg-success');
                    strengthText.text('Güçlü şifre').removeClass('text-danger text-warning').addClass('text-success');
                }
            });

            // Form submit'te loading göster
            $('form').on('submit', function() {
                var submitBtn = $(this).find('button[type="submit"]');
                submitBtn.prop('disabled', true);
                submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Kaydediliyor...');
            });
        });

        function calculatePasswordStrength(password) {
            var score = 0;
            var percentage = 0;

            if (password.length >= 6) score++;
            if (password.length >= 8) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;

            percentage = (score / 6) * 100;

            return { score: score, percentage: percentage };
        }
    </script>
}